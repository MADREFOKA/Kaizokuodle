<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Challenge</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1e3a5f 50%, #0a1929 100%);
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
        }
        .title-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05);
            color: white; transition: all 0.3s; font-size: 1rem; text-decoration: none;
            display: inline-block;
        }
        .btn:hover { border-color: #ff6b35; background: rgba(255, 107, 53, 0.2); }
        
        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; max-width: 1400px; margin-left: auto; margin-right: auto;
        }
        
        .score-box {
            background: rgba(255, 255, 255, 0.95); padding: 1.5rem 2rem;
            border-radius: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .score-box h3 { color: #1a1a2e; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .score-box .score { color: #667eea; font-size: 3rem; font-weight: 800; }
        
        .grid-container { display: flex; justify-content: center; margin: 2rem auto; }
        .grid-table {
            display: grid; grid-template-columns: 180px repeat(3, 180px);
            grid-template-rows: repeat(4, 180px); gap: 0.8rem;
        }
        .grid-cell {
            border-radius: 12px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            font-weight: 700; font-size: 1rem; text-align: center; padding: 0.8rem;
        }
        .grid-cell.header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .grid-cell.row-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .grid-cell.empty {
            background: rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.3s;
        }
        .grid-cell.empty:hover {
            background: rgba(255, 255, 255, 0.2); transform: scale(1.05);
        }
        .grid-cell.filled {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .grid-cell img {
            width: 70px; height: 70px; border-radius: 10px;
            object-fit: cover; margin-bottom: 0.5rem;
        }
        .category-label {
            font-size: 0.7rem; opacity: 0.9; margin-bottom: 0.2rem;
        }
        
        .search-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .search-modal.active { display: flex; }
        .search-content {
            background: white; padding: 2rem; border-radius: 20px;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .search-content h3 {
            color: #1a1a2e; margin-bottom: 1rem; font-size: 1.3rem;
        }
        .input-field {
            width: 100%; padding: 1rem; border-radius: 10px;
            border: 2px solid #e5e7eb; font-size: 1rem;
        }
        .search-results { margin-top: 1rem; }
        .search-result-item {
            display: flex; align-items: center; padding: 1rem;
            border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;
        }
        .search-result-item:hover { background: #f3f4f6; }
        .search-result-item img {
            width: 50px; height: 50px; border-radius: 8px;
            object-fit: cover; margin-right: 1rem;
        }
        .search-result-item span { color: #1a1a2e; font-weight: 600; }
        .error-message {
            color: #ef4444; font-weight: 600; margin-top: 1rem;
            text-align: center; font-size: 1rem;
        }
    </style>
</head>
<body>
    <div id="app">Cargando...</div>
    <div id="searchModal" class="search-modal" onclick="if(event.target.id==='searchModal') closeSearchModal()">
        <div class="search-content">
            <h3 id="modalTitle">Buscar personaje</h3>
            <input type="text" id="searchInput" class="input-field" placeholder="Escribe el nombre..." oninput="handleSearch(this.value)" />
            <div id="searchResults" class="search-results"></div>
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>
    
    <script>
        let characters = [];
        let grid = [];
        let rowCategories = [];
        let colCategories = [];
        let score = 0;
        let currentCell = null;
        
        // Categor√≠as que NO pueden repetirse en filas y columnas
        const rowTypes = ['Origen', 'Saga'];
        const colTypes = ['Afiliaci√≥n', 'Raza'];
        
        const categoryValues = {
            'Afiliaci√≥n': ['Piratas Sombrero de Paja', 'Piratas Barbablanca', 'Marines', 'Revolucionarios', 'Piratas Big Mom', 'Piratas Kaido'],
            'Origen': ['East Blue', 'Grand Line', 'North Blue', 'South Blue', 'West Blue'],
            'Raza': ['Humano', 'Gyojin', 'Mink', 'Gigante'],
            'Saga': ['East Blue', 'Arabasta', 'Skypiea', 'Enies Lobby', 'Marineford', 'Dressrosa', 'Whole Cake', 'Wano']
        };
        
        fetch('../characters.json')
            .then(r => r.json())
            .then(data => {
                characters = data.filter(c => c.Nombre && c.Imagen);
                generateGrid();
                renderGame();
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('app').innerHTML = '<div style="text-align:center;">Error cargando datos</div>';
            });
        
        function checkMatch(char, type, value) {
            const field = char[type];
            if (!field) return false;
            
            const fieldLower = field.toLowerCase();
            const valueLower = value.toLowerCase();
            
            // Para campos con m√∫ltiples valores separados por comas
            if (fieldLower.includes(',')) {
                const parts = fieldLower.split(',').map(p => p.trim());
                return parts.some(part => part === valueLower || part.includes(valueLower) || valueLower.includes(part));
            }
            
            // Para campos simples
            return fieldLower === valueLower || fieldLower.includes(valueLower) || valueLower.includes(fieldLower);
        }
        
        function findValidCombinations() {
            const validCombos = [];
            
            // Filas: Origen o Saga
            // Columnas: Afiliaci√≥n o Raza
            for (const rowType of rowTypes) {
                for (const rowValue of categoryValues[rowType]) {
                    for (const colType of colTypes) {
                        for (const colValue of categoryValues[colType]) {
                            const matches = characters.filter(c => 
                                checkMatch(c, rowType, rowValue) && checkMatch(c, colType, colValue)
                            );
                            
                            if (matches.length >= 3) {
                                validCombos.push({
                                    rowType, rowValue, colType, colValue,
                                    count: matches.length,
                                    characters: matches
                                });
                            }
                        }
                    }
                }
            }
            
            return validCombos;
        }
        
        function generateGrid() {
            const validCombos = findValidCombinations();
            console.log('Valid combinations found:', validCombos.length);
            
            if (validCombos.length < 9) {
                alert('No hay suficientes combinaciones v√°lidas. Recargando...');
                location.reload();
                return;
            }
            
            // Seleccionar 3 valores √∫nicos para filas y 3 para columnas
            const usedRowKeys = new Set();
            const usedColKeys = new Set();
            const selectedCombos = [];
            
            const shuffled = validCombos.sort(() => 0.5 - Math.random());
            
            for (const combo of shuffled) {
                const rowKey = `${combo.rowType}:${combo.rowValue}`;
                const colKey = `${combo.colType}:${combo.colValue}`;
                
                if (usedRowKeys.size < 3 && !usedRowKeys.has(rowKey)) {
                    usedRowKeys.add(rowKey);
                }
                
                if (usedColKeys.size < 3 && !usedColKeys.has(colKey)) {
                    usedColKeys.add(colKey);
                }
                
                if (usedRowKeys.size === 3 && usedColKeys.size === 3) break;
            }
            
            // Convertir a arrays
            rowCategories = Array.from(usedRowKeys).map(key => {
                const [type, value] = key.split(':');
                return { type, value };
            });
            
            colCategories = Array.from(usedColKeys).map(key => {
                const [type, value] = key.split(':');
                return { type, value };
            });
            
            console.log('Rows:', rowCategories);
            console.log('Cols:', colCategories);
            
            grid = Array(3).fill(null).map(() => Array(3).fill(null));
        }
        
        function getValidCharactersForCell(row, col) {
            const rowCat = rowCategories[row];
            const colCat = colCategories[col];
            
            const valid = characters.filter(c =>
                checkMatch(c, rowCat.type, rowCat.value) && checkMatch(c, colCat.type, colCat.value)
            );
            
            console.log(`Cell [${row},${col}]: ${rowCat.type}:${rowCat.value} + ${colCat.type}:${colCat.value} = ${valid.length} characters`);
            return valid;
        }
        
        function openSearchModal(row, col) {
            currentCell = { row, col };
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            const title = document.getElementById('modalTitle');
            
            const rowCat = rowCategories[row];
            const colCat = colCategories[col];
            
            title.textContent = `${rowCat.type}: ${rowCat.value} + ${colCat.type}: ${colCat.value}`;
            input.value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('errorMessage').textContent = '';
            
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }
        
        function closeSearchModal() {
            document.getElementById('searchModal').classList.remove('active');
            currentCell = null;
        }
        
        function handleSearch(value) {
            const resultsDiv = document.getElementById('searchResults');
            document.getElementById('errorMessage').textContent = '';
            
            if (!value) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const filtered = characters.filter(c => 
                c.Nombre.toLowerCase().includes(value.toLowerCase())
            ).slice(0, 15);
            
            if (filtered.length > 0) {
                resultsDiv.innerHTML = filtered.map(c => `
                    <div class="search-result-item" onclick="selectCharacter('${c.Nombre.replace(/'/g, "\\'")}')">
                        <img src="${c.Imagen}" onerror="this.style.display='none'" />
                        <span>${c.Nombre}</span>
                    </div>
                `).join('');
            } else {
                resultsDiv.innerHTML = '<p style="text-align:center; color: #666; padding: 1rem;">No se encontraron personajes</p>';
            }
        }
        
        function selectCharacter(name) {
            const char = characters.find(c => c.Nombre === name);
            if (!char || !currentCell) return;
            
            const { row, col } = currentCell;
            const validChars = getValidCharactersForCell(row, col);
            
            console.log('Selected:', char.Nombre);
            console.log('Valid characters for this cell:', validChars.map(c => c.Nombre));
            
            if (validChars.some(c => c.Nombre === char.Nombre)) {
                grid[row][col] = char;
                score++;
                closeSearchModal();
                renderGame();
                
                if (score === 9) {
                    setTimeout(() => alert('üéâ ¬°COMPLETADO! üéâ'), 500);
                }
            } else {
                const rowCat = rowCategories[row];
                const colCat = colCategories[col];
                const match1 = checkMatch(char, rowCat.type, rowCat.value);
                const match2 = checkMatch(char, colCat.type, colCat.value);
                
                console.log(`${char.Nombre}: ${rowCat.type}=${match1}, ${colCat.type}=${match2}`);
                document.getElementById('errorMessage').textContent = `‚ùå ${char.Nombre} no cumple ambas categor√≠as`;
            }
        }
        
        function renderGame() {
            document.getElementById('app').innerHTML = `
                <div class="header-container">
                    <a href="../index.html" class="btn">‚Üê Volver</a>
                    <h1 class="title-font" style="font-size: 3rem; background: linear-gradient(to right, #667eea, #764ba2); -webkit-background-clip: text; background-clip: text; color: transparent;">GRID CHALLENGE</h1>
                    <div class="score-box">
                        <h3>Puntos</h3>
                        <div class="score">${score}/9</div>
                    </div>
                </div>
                
                <div class="grid-container">
                    <div class="grid-table">
                        <div class="grid-cell" style="background: transparent;"></div>
                        
                        ${colCategories.map(cat => `
                            <div class="grid-cell header">
                                <div class="category-label">${cat.type}</div>
                                <div>${cat.value}</div>
                            </div>
                        `).join('')}
                        
                        ${rowCategories.map((rowCat, rowIdx) => `
                            <div class="grid-cell row-header">
                                <div class="category-label">${rowCat.type}</div>
                                <div>${rowCat.value}</div>
                            </div>
                            ${colCategories.map((colCat, colIdx) => {
                                const cell = grid[rowIdx][colIdx];
                                if (cell) {
                                    return `
                                        <div class="grid-cell filled">
                                            <img src="${cell.Imagen}" onerror="this.style.display='none'" />
                                            <div style="font-size: 0.9rem;">${cell.Nombre}</div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="grid-cell empty" onclick="openSearchModal(${rowIdx}, ${colIdx})">
                                            <div style="font-size: 4rem; opacity: 0.5;">?</div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        `).join('')}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
