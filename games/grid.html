<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Challenge</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1e3a5f 50%, #0a1929 100%);
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
        }
        .title-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05);
            color: white; transition: all 0.3s; font-size: 1rem; text-decoration: none; display: inline-block;
        }
        .btn:hover { border-color: #ff6b35; background: rgba(255, 107, 53, 0.2); }
        
        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; max-width: 1600px; margin-left: auto; margin-right: auto;
        }
        
        .score-box {
            background: rgba(255, 255, 255, 0.95); padding: 1.5rem 2rem;
            border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .score-box h3 { color: #1a1a2e; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .score-box .score { color: #667eea; font-size: 3rem; font-weight: 800; }
        
        .search-container {
            max-width: 800px; margin: 0 auto 2rem; position: relative;
        }
        .input-field {
            width: 100%; padding: 1rem; border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: white; color: black; font-size: 1.1rem;
        }
        .suggestions {
            position: absolute; width: 100%; background: white;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 400px; overflow-y: auto; z-index: 100; margin-top: 0.5rem;
        }
        .suggestion-item {
            display: flex; align-items: center; padding: 1rem;
            border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;
        }
        .suggestion-item:hover { background: #f3f4f6; }
        .suggestion-item img {
            width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 1rem;
        }
        .suggestion-item span { color: #1a1a2e; font-weight: 600; }
        .error-message {
            color: #ef4444; font-weight: 700; margin-top: 1rem;
            text-align: center; font-size: 1.1rem; padding: 1rem;
            background: rgba(239, 68, 68, 0.1); border-radius: 10px;
        }
        .success-message {
            color: #10b981; font-weight: 700; margin-top: 1rem;
            text-align: center; font-size: 1.1rem; padding: 1rem;
            background: rgba(16, 185, 129, 0.1); border-radius: 10px;
        }
        
        .grid-container { display: flex; justify-content: center; margin: 2rem auto; }
        .grid-table {
            display: grid; grid-template-columns: 200px repeat(3, 200px);
            grid-template-rows: repeat(4, 200px); gap: 1rem;
        }
        .grid-cell {
            border-radius: 15px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            font-weight: 700; font-size: 1.05rem; text-align: center; padding: 1rem;
        }
        .grid-cell.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .grid-cell.row-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .grid-cell.empty {
            background: rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.3s;
            border: 3px dashed rgba(255, 255, 255, 0.3);
        }
        .grid-cell.empty:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.03); }
        .grid-cell.empty.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.8);
        }
        .grid-cell.filled { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .grid-cell img {
            width: 80px; height: 80px; border-radius: 12px; object-fit: cover; margin-bottom: 0.5rem;
        }
        .category-label { font-size: 0.75rem; opacity: 0.95; margin-bottom: 0.3rem; }
    </style>
</head>
<body>
    <div id="app">Cargando...</div>
    
    <script>
        let characters = [];
        let grid = [];
        let rowCategories = [];
        let colCategories = [];
        let score = 0;
        let selectedCell = null;
        
        // Categor√≠as L√ìGICAS
        const possibleCombinations = [
            // Afiliaci√≥n + Haki
            { row: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' }, col: { type: 'Haki', value: 'Armadura' } },
            { row: { type: 'Afiliaci√≥n', value: 'Marines' }, col: { type: 'Haki', value: 'Observaci√≥n' } },
            { row: { type: 'Afiliaci√≥n', value: 'Piratas Barbablanca' }, col: { type: 'Haki', value: 'Conquistador' } },
            
            // Origen + Afiliaci√≥n
            { row: { type: 'Origen', value: 'East Blue' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' } },
            { row: { type: 'Origen', value: 'Grand Line' }, col: { type: 'Afiliaci√≥n', value: 'Marines' } },
            { row: { type: 'Origen', value: 'North Blue' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' } },
            
            // Saga + Afiliaci√≥n
            { row: { type: 'Saga', value: 'Arabasta' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' } },
            { row: { type: 'Saga', value: 'Enies Lobby' }, col: { type: 'Afiliaci√≥n', value: 'Marines' } },
            { row: { type: 'Saga', value: 'Marineford' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Barbablanca' } },
            { row: { type: 'Saga', value: 'Dressrosa' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' } },
            { row: { type: 'Saga', value: 'Wano' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Kaido' } },
            
            // Fruta + Afiliaci√≥n
            { row: { type: 'Fruta del diablo', value: 'Paramecia' }, col: { type: 'Afiliaci√≥n', value: 'Piratas Sombrero de Paja' } },
            { row: { type: 'Fruta del diablo', value: 'Zoan' }, col: { type: 'Afiliaci√≥n', value: 'Marines' } },
            { row: { type: 'Fruta del diablo', value: 'Logia' }, col: { type: 'Afiliaci√≥n', value: 'Marines' } }
        ];
        
        fetch('../characters.json')
            .then(r => r.json())
            .then(data => {
                characters = data.filter(c => c.Nombre && c.Imagen);
                generateGrid();
                renderGame();
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('app').innerHTML = '<div style="text-align:center;">Error cargando datos</div>';
            });
        
        function checkMatch(char, type, value) {
            const field = char[type];
            if (!field || field === '---') return false;
            
            const fieldLower = field.toLowerCase().trim();
            const valueLower = value.toLowerCase().trim();
            
            if (fieldLower.includes(',')) {
                const parts = fieldLower.split(',').map(p => p.trim());
                return parts.some(part => part === valueLower || part.includes(valueLower));
            }
            
            return fieldLower === valueLower || fieldLower.includes(valueLower);
        }
        
        function generateGrid() {
            // Filtrar combinaciones v√°lidas (3+ personajes)
            const validCombos = possibleCombinations.filter(combo => {
                const matches = characters.filter(c =>
                    checkMatch(c, combo.row.type, combo.row.value) &&
                    checkMatch(c, combo.col.type, combo.col.value)
                );
                return matches.length >= 3;
            });
            
            console.log('Valid combos:', validCombos.length);
            
            if (validCombos.length < 9) {
                alert('Error: No hay suficientes combinaciones v√°lidas');
                return;
            }
            
            // Seleccionar 9 combinaciones √∫nicas
            const shuffled = validCombos.sort(() => 0.5 - Math.random());
            const usedRows = new Set();
            const usedCols = new Set();
            const selected = [];
            
            for (const combo of shuffled) {
                const rowKey = `${combo.row.type}:${combo.row.value}`;
                const colKey = `${combo.col.type}:${combo.col.value}`;
                
                if (!usedRows.has(rowKey) && !usedCols.has(colKey) && selected.length < 9) {
                    selected.push(combo);
                    usedRows.add(rowKey);
                    usedCols.add(colKey);
                }
                
                if (selected.length === 9) break;
            }
            
            // Organizar en 3x3
            rowCategories = [...new Set(selected.map(s => JSON.stringify(s.row)))].slice(0, 3).map(s => JSON.parse(s));
            colCategories = [...new Set(selected.map(s => JSON.stringify(s.col)))].slice(0, 3).map(s => JSON.parse(s));
            
            grid = Array(3).fill(null).map(() => Array(3).fill(null));
        }
        
        function getValidCharactersForCell(row, col) {
            const rowCat = rowCategories[row];
            const colCat = colCategories[col];
            
            return characters.filter(c =>
                checkMatch(c, rowCat.type, rowCat.value) &&
                checkMatch(c, colCat.type, colCat.value)
            );
        }
        
        function selectCell(row, col) {
            if (grid[row][col]) return; // Ya est√° llena
            
            selectedCell = { row, col };
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
            document.getElementById('suggestions').innerHTML = '';
            document.getElementById('message').innerHTML = '';
            renderGame();
        }
        
        function handleSearch(value) {
            const suggestionsDiv = document.getElementById('suggestions');
            document.getElementById('message').innerHTML = '';
            
            if (!value || !selectedCell) {
                suggestionsDiv.innerHTML = '';
                return;
            }
            
            const filtered = characters.filter(c =>
                c.Nombre.toLowerCase().includes(value.toLowerCase())
            ).slice(0, 15);
            
            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = filtered.map(c => `
                    <div class="suggestion-item" onclick="selectCharacter('${c.Nombre.replace(/'/g, "\\'")}')">
                        <img src="${c.Imagen}" onerror="this.style.display='none'" />
                        <span>${c.Nombre}</span>
                    </div>
                `).join('');
            } else {
                suggestionsDiv.innerHTML = '';
            }
        }
        
        function selectCharacter(name) {
            const char = characters.find(c => c.Nombre === name);
            if (!char || !selectedCell) return;
            
            const { row, col } = selectedCell;
            const validChars = getValidCharactersForCell(row, col);
            
            if (validChars.some(c => c.Nombre === char.Nombre)) {
                grid[row][col] = char;
                score++;
                selectedCell = null;
                document.getElementById('searchInput').value = '';
                document.getElementById('suggestions').innerHTML = '';
                document.getElementById('message').innerHTML = '<div class="success-message">‚úÖ ¬°Correcto!</div>';
                
                setTimeout(() => {
                    document.getElementById('message').innerHTML = '';
                    if (score === 9) {
                        alert('üéâ ¬°COMPLETADO! üéâ');
                    }
                    renderGame();
                }, 1000);
            } else {
                document.getElementById('message').innerHTML = `<div class="error-message">‚ùå ${char.Nombre} no cumple ambas categor√≠as</div>`;
            }
        }
        
        function renderGame() {
            document.getElementById('app').innerHTML = `
                <div class="header-container">
                    <a href="../index.html" class="btn">‚Üê Volver</a>
                    <h1 class="title-font" style="font-size: 3rem; background: linear-gradient(to right, #667eea, #764ba2); -webkit-background-clip: text; background-clip: text; color: transparent;">GRID CHALLENGE</h1>
                    <div class="score-box">
                        <h3>Puntos</h3>
                        <div class="score">${score}/9</div>
                    </div>
                </div>
                
                <div class="search-container">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="input-field" 
                        placeholder="${selectedCell ? 'Escribe el nombre del personaje...' : 'Selecciona una celda primero'}"
                        oninput="handleSearch(this.value)"
                        ${!selectedCell ? 'disabled' : ''}
                    />
                    <div id="suggestions" class="suggestions"></div>
                </div>
                
                <div id="message"></div>
                
                <div class="grid-container">
                    <div class="grid-table">
                        <div class="grid-cell" style="background: transparent;"></div>
                        
                        ${colCategories.map(cat => `
                            <div class="grid-cell header">
                                <div class="category-label">${cat.type}</div>
                                <div>${cat.value}</div>
                            </div>
                        `).join('')}
                        
                        ${rowCategories.map((rowCat, rowIdx) => `
                            <div class="grid-cell row-header">
                                <div class="category-label">${rowCat.type}</div>
                                <div>${rowCat.value}</div>
                            </div>
                            ${colCategories.map((colCat, colIdx) => {
                                const cell = grid[rowIdx][colIdx];
                                const isSelected = selectedCell && selectedCell.row === rowIdx && selectedCell.col === colIdx;
                                
                                if (cell) {
                                    return `
                                        <div class="grid-cell filled">
                                            <img src="${cell.Imagen}" onerror="this.style.display='none'" />
                                            <div style="font-size: 0.95rem;">${cell.Nombre}</div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="grid-cell empty ${isSelected ? 'selected' : ''}" onclick="selectCell(${rowIdx}, ${colIdx})">
                                            <div style="font-size: 4rem; opacity: 0.4;">?</div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        `).join('')}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
