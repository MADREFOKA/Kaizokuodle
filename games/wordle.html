<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adivina el Personaje</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1e3a5f 50%, #0a1929 100%);
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
        }
        .title-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600;
            cursor: pointer; border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05); color: white;
            transition: all 0.3s; font-size: 1rem;
        }
        .btn:hover { border-color: #ff6b35; background: rgba(255, 107, 53, 0.2); }
        .btn.active { background: #ff6b35; border-color: #ff6b35; }
        .btn-primary { background: #ff6b35; border-color: #ff6b35; }
        .btn-primary:hover { background: #ff8555; }
        
        .game-table {
            border-collapse: separate;
            border-spacing: 0.5rem;
            margin: 0 auto;
            table-layout: fixed;
        }
        .game-table th, .game-table td {
            width: 110px;
            height: 80px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a2e;
            line-height: 1.3;
            overflow: hidden;
        }
        .game-table th {
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.95);
        }
        .game-table th.imagen, .game-table td.imagen {
            width: 90px;
        }
        .game-table th.nombre, .game-table td.nombre {
            width: 140px;
        }
        .game-table th.recompensa, .game-table td.recompensa {
            width: 170px;
        }
        .game-table td.correct {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .game-table td.partial {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .game-table td.incorrect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .game-table img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }
        .arrow {
            font-size: 1.5rem;
            font-weight: bold;
            margin-left: 0.25rem;
        }
        
        .legend-badge {
            display: inline-flex; align-items: center; padding: 0.75rem 1.25rem;
            border-radius: 8px; margin: 0 0.5rem; font-size: 1rem;
            cursor: help; position: relative; font-weight: 600;
        }
        .legend-badge:hover .tooltip { opacity: 1; visibility: visible; }
        .tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); color: white; padding: 0.5rem 1rem;
            border-radius: 6px; font-size: 0.9rem; white-space: nowrap;
            margin-bottom: 8px; opacity: 0; visibility: hidden; transition: all 0.3s; z-index: 1000;
        }
        .tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border: 6px solid transparent; border-top-color: rgba(0, 0, 0, 0.9);
        }
        .input-field {
            width: 100%; padding: 1rem; border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: white; color: black; font-size: 1.1rem;
        }
        .suggestions {
            position: absolute; width: 100%; background: white;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 300px; overflow-y: auto; z-index: 100; margin-top: 0.5rem;
        }
        .suggestion-item {
            padding: 1rem; border-bottom: 1px solid #e5e7eb;
            cursor: pointer; color: black; transition: background 0.2s;
        }
        .suggestion-item:hover { background: #f3f4f6; }
        .result-image {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            object-fit: cover;
            border: 3px solid #ff6b35;
            margin-bottom: 1rem;
        }
        .result-box-win {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 3px solid #10b981;
        }
        .result-box-lose {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 3px solid #ef4444;
        }
    </style>
</head>
<body>
    <div id="app">Cargando...</div>
    
    <script>
        let characters = [];
        let difficulty = 2;
        let target = null;
        let guesses = [];
        let gameStarted = false;
        let gameOver = false;
        
        const difficulties = [
            { id: 1, name: 'Grumete', levels: [1] },
            { id: 2, name: 'Novato'', levels: [1, 2] },
            { id: 3, name: 'Supernova'', levels: [1, 2, 3] },
            { id: 4, name: 'Shichibukai', levels: [1, 2, 3, 4] },
            { id: 5, name: 'Yonkou', levels: [1, 2, 3, 4, 5] }
        ];
        
        const fields = ['Imagen', 'Nombre', 'Primera Aparici√≥n', 'Saga', 'Arco', 'Origen', 'Raza', 'Sexo', 'Estado', 'Altura', 'Edad', 'Cumplea√±os', 'Fruta del diablo', 'Haki', 'Recompensa', 'Afiliaci√≥n', 'Ocupaci√≥n'];
        
        fetch('../characters.json')
            .then(r => r.json())
            .then(data => {
                characters = data;
                renderMenu();
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('app').innerHTML = '<div style="text-align:center; padding: 3rem;">Error cargando datos. <a href="../index.html" style="color: #ff6b35;">Volver al men√∫</a></div>';
            });
        
        function getValidCharacters() {
            const diff = difficulties.find(d => d.id === difficulty);
            return characters.filter(c => c.Nombre && diff.levels.includes(parseInt(c.Dificultad)));
        }
        
        function startGame() {
            const valid = getValidCharacters();
            target = valid[Math.floor(Math.random() * valid.length)];
            guesses = [];
            gameStarted = true;
            gameOver = false;
            renderGame();
        }
        
        function formatName(name) {
            if (!name) return name;
            return name.replace(/\s*\/\s*/g, '<br>');
        }
        
        function formatMultiValue(value) {
            if (!value || value === '---') return value;
            return value.split(',').map(v => v.trim()).join('<br>');
        }
        
        function compareBirthday(guessVal, targetVal) {
            const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            
            const parseDate = (str) => {
                const parts = str.toLowerCase().split(' ').filter(p => p);
                if (parts.length < 2) return null;
                const day = parseInt(parts[0]);
                const monthIdx = months.indexOf(parts[1]);
                return monthIdx !== -1 ? { day, month: monthIdx } : null;
            };
            
            const gDate = parseDate(guessVal);
            const tDate = parseDate(targetVal);
            
            if (!gDate || !tDate) return null;
            
            const gTotal = gDate.month * 31 + gDate.day;
            const tTotal = tDate.month * 31 + tDate.day;
            
            return gTotal < tTotal ? '‚Üë' : (gTotal > tTotal ? '‚Üì' : null);
        }
        
        function compareValues(guess, target, field) {
            if (field === 'Imagen') return { status: '', arrow: null };
            
            const g = (guess[field] || '').toString().toLowerCase().trim();
            const t = (target[field] || '').toString().toLowerCase().trim();
            
            if (g === t) return { status: 'correct', arrow: null };
            
            if (['Primera Aparici√≥n', 'Altura', 'Edad', 'Recompensa'].includes(field)) {
                const gNum = parseFloat(g.replace(/[^\d.]/g, ''));
                const tNum = parseFloat(t.replace(/[^\d.]/g, ''));
                if (!isNaN(gNum) && !isNaN(tNum)) {
                    return { status: 'incorrect', arrow: gNum < tNum ? '‚Üë' : '‚Üì' };
                }
            }
            
            if (field === 'Cumplea√±os') {
                const arrow = compareBirthday(g, t);
                if (arrow) return { status: 'incorrect', arrow };
            }
            
            if (['Raza', 'Fruta del diablo', 'Haki', 'Ocupaci√≥n', 'Afiliaci√≥n'].includes(field)) {
                const gParts = g.split(',').map(p => p.trim().toLowerCase());
                const tParts = t.split(',').map(p => p.trim().toLowerCase());
                
                const hasMatch = gParts.some(gp => tParts.some(tp => gp === tp || gp.includes(tp) || tp.includes(gp)));
                
                if (hasMatch) return { status: 'partial', arrow: null };
            }
            
            return { status: 'incorrect', arrow: null };
        }
        
        function handleGuess(char) {
            guesses.push(char);
            
            if (char.Nombre === target.Nombre) {
                gameOver = true;
            }
            // SIN L√çMITE DE INTENTOS - removido el else if
            
            renderGame();
        }
        
        function surrender() {
            gameOver = true;
            renderGame();
        }
        
        function renderMenu() {
            document.getElementById('app').innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <a href="../index.html" class="btn" style="display: inline-block; margin-bottom: 2rem; text-decoration: none;">‚Üê Volver</a>
                    
                    <h1 class="title-font" style="font-size: 3.5rem; text-align: center; margin-bottom: 3rem; background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent;">
                        ADIVINA EL PERSONAJE
                    </h1>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 3rem;">
                        ${difficulties.map(d => `
                            <button class="btn ${difficulty === d.id ? 'active' : ''}" onclick="difficulty = ${d.id}; renderMenu();">
                                ${d.name}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="startGame()" style="font-size: 1.25rem; padding: 1rem 2rem;">
                            Comenzar
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderGame() {
            const won = guesses.some(g => g.Nombre === target.Nombre);
            
            document.getElementById('app').innerHTML = `
                <div style="max-width: 100%; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <a href="../index.html" class="btn" style="text-decoration: none;">‚Üê Menu</a>
                        <h1 class="title-font" style="font-size: 2.5rem; background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent;">ADIVINA EL PERSONAJE</h1>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="startGame()">üîÑ</button>
                            <button class="btn" onclick="surrender()" ${gameOver ? 'disabled' : ''}>üè≥Ô∏è</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem;">
                        ${difficulties.map(d => `
                            <button class="btn ${difficulty === d.id ? 'active' : ''}" onclick="difficulty = ${d.id}; startGame();">
                                ${d.name}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                        <div style="display: inline-flex; align-items: center; background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 1rem;">
                            <span style="font-weight: bold; color: black; margin-right: 1rem; font-size: 1.1rem;">Leyenda:</span>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                                Verde
                                <div class="tooltip">Correcto - Valor exacto</div>
                            </div>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                                Amarillo
                                <div class="tooltip">Parcial - Al menos un valor coincide</div>
                            </div>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                                Rojo
                                <div class="tooltip">Incorrecto - Flechas indican direcci√≥n</div>
                            </div>
                        </div>
                    </div>
                    
                    ${!gameOver ? `
                        <div style="max-width: 800px; margin: 0 auto 2rem; position: relative;">
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="input-field" 
                                placeholder="Escribe el nombre del personaje..."
                                oninput="handleSearch(this.value)"
                            />
                            <div id="suggestions"></div>
                        </div>
                    ` : ''}
                    
                    <div style="overflow-x: auto; display: flex; justify-content: center;">
                        <table class="game-table">
                            <thead>
                                <tr>
                                    ${fields.map(f => {
                                        let className = '';
                                        if (f === 'Imagen') className = 'imagen';
                                        else if (f === 'Nombre') className = 'nombre';
                                        else if (f === 'Recompensa') className = 'recompensa';
                                        return `<th class="${className}">${f}</th>`;
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${guesses.map(g => `
                                    <tr>
                                        ${fields.map(f => {
                                            if (f === 'Imagen') {
                                                return `<td class="imagen"><img src="${g.Imagen}" onerror="this.style.display='none'" /></td>`;
                                            }
                                            
                                            const comp = f === 'Nombre' 
                                                ? { status: g.Nombre === target.Nombre ? 'correct' : 'incorrect', arrow: null }
                                                : compareValues(g, target, f);
                                            
                                            let displayValue = g[f] || '---';
                                            if (f === 'Nombre') {
                                                displayValue = formatName(g[f]);
                                            } else if (['Haki', 'Ocupaci√≥n'].includes(f)) {
                                                displayValue = formatMultiValue(g[f]);
                                            }
                                            
                                            let className = comp.status;
                                            if (f === 'Nombre') className += ' nombre';
                                            else if (f === 'Recompensa') className += ' recompensa';
                                            
                                            return `
                                                <td class="${className}">
                                                    ${displayValue}${comp.arrow ? `<span class="arrow">${comp.arrow}</span>` : ''}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${gameOver ? `
                        <div class="${won ? 'result-box-win' : 'result-box-lose'}" style="max-width: 600px; margin: 3rem auto; text-align: center; padding: 2rem; border-radius: 20px; color: black;">
                            <img src="${target.Imagen}" class="result-image" onerror="this.style.display='none'" />
                            <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: ${won ? '#059669' : '#dc2626'};">${won ? 'üéâ ¬°GANASTE! üéâ' : 'üò¢ PERDISTE üò¢'}</h2>
                            <p style="font-size: 1.5rem; margin-bottom: 2rem;">El personaje era: <strong style="color: #ff6b35;">${target.Nombre}</strong></p>
                            <button class="btn btn-primary" onclick="startGame()" style="font-size: 1.25rem; padding: 1rem 2rem;">Jugar de nuevo</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (!gameOver) {
                document.getElementById('searchInput').focus();
            }
        }
        
        function handleSearch(value) {
            const suggestionsDiv = document.getElementById('suggestions');
            if (!value) {
                suggestionsDiv.innerHTML = '';
                return;
            }
            
            const valid = getValidCharacters();
            const filtered = valid.filter(c => c.Nombre.toLowerCase().includes(value.toLowerCase())).slice(0, 10);
            
            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = `
                    <div class="suggestions">
                        ${filtered.map(c => `
                            <div class="suggestion-item" onclick="selectCharacter('${c.Nombre.replace(/'/g, "\\'")}')">
                                ${c.Nombre}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                suggestionsDiv.innerHTML = '';
            }
        }
        
        function selectCharacter(name) {
            const char = characters.find(c => c.Nombre === name);
            if (char) {
                handleGuess(char);
            }
        }
    </script>
</body>
</html>
