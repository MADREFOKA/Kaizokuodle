<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adivina el Personaje</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/utils.js"></script>
<script src="../report-system.js"></script>
</head>
<body>
<script>const reporter = new ErrorReporter("Adivina el Personaje");</script>
    <div id="app">Cargando...</div>
    
    <script>
        let characters = [];
        let difficulty = 2;
        let target = null;
        let guesses = [];
        let gameStarted = false;
        let gameOver = false;
        
        const difficulties = [
            { id: 1, name: 'Grumete', label: 'F√°cil', levels: [1] },
            { id: 2, name: 'Novato', label: 'Medio', levels: [1, 2] },
            { id: 3, name: 'Supernova', label: 'Dif√≠cil', levels: [1, 2, 3] },
            { id: 4, name: 'Shichibukai', label: 'Muy Dif√≠cil', levels: [1, 2, 3, 4] },
            { id: 5, name: 'Yonkou', label: 'Imposible', levels: [1, 2, 3, 4, 5] }
        ];
        
        const fields = ['Imagen', 'Nombre', 'Primera Aparici√≥n', 'Saga', 'Arco', 'Origen', 'Raza', 'Sexo', 'Estado', 'Altura', 'Edad', 'Cumplea√±os', 'Fruta del diablo', 'Haki', 'Recompensa', 'Afiliaci√≥n', 'Ocupaci√≥n'];
        
        loadData().then(data => {
            characters = data.characters;
            renderMenu();
        }).catch(err => {
            console.error('Error:', err);
            document.getElementById('app').innerHTML = '<div style="text-align:center; padding: 3rem;">Error cargando datos. <a href="../index.html" style="color: #ff6b35;">Volver al men√∫</a></div>';
        });
        
        function getValidCharacters() {
            const diff = difficulties.find(d => d.id === difficulty);
            return characters.filter(c => c.Nombre && diff.levels.includes(parseInt(c.Dificultad)));
        }
        
        function startGame() {
            const valid = getValidCharacters();
            target = valid[Math.floor(Math.random() * valid.length)];
            guesses = [];
            gameStarted = true;
            gameOver = false;
            renderGame();
        }
        
        function formatName(name) {
            if (!name) return name;
            return name.replace(/\s*\/\s*/g, '<br>');
        }
        
        function formatMultiValue(value) {
            if (!value || value === '---') return value;
            return value.split(',').map(v => v.trim()).join('<br>');
        }
        
        function compareBirthday(guessVal, targetVal) {
            const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            
            const parseDate = (str) => {
                const parts = str.toLowerCase().split(' ').filter(p => p);
                if (parts.length < 2) return null;
                const day = parseInt(parts[0]);
                const monthIdx = months.indexOf(parts[1]);
                return monthIdx !== -1 ? { day, month: monthIdx } : null;
            };
            
            const gDate = parseDate(guessVal);
            const tDate = parseDate(targetVal);
            
            if (!gDate || !tDate) return null;
            
            const gTotal = gDate.month * 31 + gDate.day;
            const tTotal = tDate.month * 31 + tDate.day;
            
            return gTotal < tTotal ? '‚Üë' : (gTotal > tTotal ? '‚Üì' : null);
        }
        
        function compareValues(guess, target, field) {
            if (field === 'Imagen') return { status: '', arrow: null };
            
            const g = (guess[field] || '').toString().toLowerCase().trim();
            const t = (target[field] || '').toString().toLowerCase().trim();
            
            if (g === t) return { status: 'correct', arrow: null };
            
            if (['Primera Aparici√≥n', 'Altura', 'Edad', 'Recompensa'].includes(field)) {
                const gNum = parseFloat(g.replace(/[^\d.]/g, ''));
                const tNum = parseFloat(t.replace(/[^\d.]/g, ''));
                if (!isNaN(gNum) && !isNaN(tNum)) {
                    return { status: 'incorrect', arrow: gNum < tNum ? '‚Üë' : '‚Üì' };
                }
            }
            
            if (field === 'Cumplea√±os') {
                const arrow = compareBirthday(g, t);
                if (arrow) return { status: 'incorrect', arrow };
            }
            
            if (['Raza', 'Fruta del diablo', 'Haki', 'Ocupaci√≥n', 'Afiliaci√≥n'].includes(field)) {
                const gParts = g.split(',').map(p => p.trim().toLowerCase());
                const tParts = t.split(',').map(p => p.trim().toLowerCase());
                
                const hasMatch = gParts.some(gp => tParts.some(tp => gp === tp || gp.includes(tp) || tp.includes(gp)));
                
                if (hasMatch) return { status: 'partial', arrow: null };
            }
            
            return { status: 'incorrect', arrow: null };
        }
        
        function handleGuess(char) {
            guesses.push(char);
            
            if (char.Nombre === target.Nombre) {
                gameOver = true;
            }
            
            renderGame();
        }
        
        function surrender() {
            gameOver = true;
            renderGame();
        }
        
        function renderMenu() {
            document.getElementById('app').innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <a href="../index.html" class="btn" style="display: inline-block; margin-bottom: 2rem; text-decoration: none;">‚Üê Volver</a>
                    
                    <h1 class="title-font" style="font-size: 3.5rem; text-align: center; margin-bottom: 3rem; background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent;">
                        ADIVINA EL PERSONAJE
                    </h1>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 3rem;">
                        ${difficulties.map(d => `
                            <button class="btn ${difficulty === d.id ? 'active' : ''}" onclick="difficulty = ${d.id}; renderMenu();">
                                ${d.name}<br><small>(${d.label})</small>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="startGame()" style="font-size: 1.25rem; padding: 1rem 2rem;">
                            Comenzar
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderGame() {
            const won = guesses.some(g => g.Nombre === target.Nombre);
            
            document.getElementById('app').innerHTML = `
                <div style="max-width: 100%; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                        <a href="../index.html" class="btn" style="text-decoration: none;">‚Üê Menu</a>
                        <h1 class="title-font" style="font-size: 2.5rem; background: linear-gradient(to right, #a855f7, #ec4899); -webkit-background-clip: text; background-clip: text; color: transparent;">ADIVINA EL PERSONAJE</h1>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="startGame()">üîÑ</button>
                            <button class="btn" onclick="surrender()" ${gameOver ? 'disabled' : ''}>üè≥Ô∏è</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem;">
                        ${difficulties.map(d => `
                            <button class="btn ${difficulty === d.id ? 'active' : ''}" onclick="difficulty = ${d.id}; startGame();">
                                ${d.name}<br><small>(${d.label})</small>
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                        <div class="legend-container">
                            <span style="font-weight: bold; color: black; margin-right: 1rem; font-size: 1.1rem;">Leyenda:</span>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                                Verde
                                <div class="tooltip">Correcto - Valor exacto</div>
                            </div>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                                Amarillo
                                <div class="tooltip">Parcial - Al menos un valor coincide</div>
                            </div>
                            <div class="legend-badge" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                                Rojo
                                <div class="tooltip">Incorrecto - Flechas indican direcci√≥n</div>
                            </div>
                        </div>
                    </div>
                    
                    ${!gameOver ? `
                        <div style="max-width: 800px; margin: 0 auto 2rem; position: relative;">
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="input-field" 
                                placeholder="Escribe el nombre del personaje..."
                                oninput="handleSearch(this.value)"
                            />
                            <div id="suggestions"></div>
                        </div>
                    ` : ''}
                    
                    <div style="overflow-x: auto; display: flex; justify-content: center;">
                        <table class="game-table">
                            <thead>
                                <tr>
                                    ${fields.map(f => {
                                        let className = '';
                                        if (f === 'Imagen') className = 'imagen';
                                        else if (f === 'Nombre') className = 'nombre';
                                        else if (f === 'Recompensa') className = 'recompensa';
                                        return `<th class="${className}">${f}</th>`;
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${guesses.map(g => `
                                    <tr>
                                        ${fields.map(f => {
                                            if (f === 'Imagen') {
                                                return `<td class="imagen"><img src="${g.Imagen}" onerror="this.style.display='none'" /></td>`;
                                            }
                                            
                                            const comp = f === 'Nombre' 
                                                ? { status: g.Nombre === target.Nombre ? 'correct' : 'incorrect', arrow: null }
                                                : compareValues(g, target, f);
                                            
                                            let displayValue = g[f] || '---';
                                            if (f === 'Nombre') {
                                                displayValue = formatName(g[f]);
                                            } else if (['Haki', 'Ocupaci√≥n'].includes(f)) {
                                                displayValue = formatMultiValue(g[f]);
                                            }
                                            
                                            let className = comp.status;
                                            if (f === 'Nombre') className += ' nombre';
                                            else if (f === 'Recompensa') className += ' recompensa';
                                            
                                            return `
                                                <td class="${className}">
                                                    ${displayValue}${comp.arrow ? `<span class="arrow">${comp.arrow}</span>` : ''}
                                                </td>
                                            `;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${gameOver ? `
                        <div class="${won ? 'result-box-win' : 'result-box-lose'}" style="max-width: 600px; margin: 3rem auto; text-align: center; padding: 2rem; border-radius: 20px; color: black;">
                            <img src="${target.Imagen}" class="result-image" onerror="this.style.display='none'" />
                            <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: ${won ? '#059669' : '#dc2626'};">${won ? 'üéâ ¬°GANASTE! üéâ' : 'üò¢ PERDISTE üò¢'}</h2>
                            <p style="font-size: 1.5rem; margin-bottom: 2rem;">El personaje era: <strong style="color: #ff6b35;">${target.Nombre}</strong></p>
                            <button class="btn btn-primary" onclick="startGame()" style="font-size: 1.25rem; padding: 1rem 2rem;">Jugar de nuevo</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (!gameOver) {
                document.getElementById('searchInput').focus();
            }
        }
        
        function handleSearch(value) {
            const suggestionsDiv = document.getElementById('suggestions');
            if (!value) {
                suggestionsDiv.innerHTML = '';
                return;
            }
            
            const valid = getValidCharacters();
            const filtered = valid.filter(c => c.Nombre.toLowerCase().includes(value.toLowerCase())).slice(0, 10);
            
            if (filtered.length > 0) {
                suggestionsDiv.innerHTML = `
                    <div class="suggestions">
                        ${filtered.map(c => `
                            <div class="suggestion-item" onclick="selectCharacter('${c.Nombre.replace(/'/g, "\\'")}')">
                                <img src="${c.Imagen}" onerror="this.style.display='none'" style="width: 40px; height: 40px; border-radius: 6px; object-fit: cover; margin-right: 0.75rem;" />
                                ${c.Nombre}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                suggestionsDiv.innerHTML = '';
            }
        }
        
        function selectCharacter(name) {
            const char = characters.find(c => c.Nombre === name);
            if (char) {
                handleGuess(char);
            }
        }
    </script>
</body>
</html>
