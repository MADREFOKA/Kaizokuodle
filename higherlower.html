<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Higher or Lower - One Piece Bounties</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="https://www.icons101.com/icons/93/Token_Anime_Pack_by_Erehr/128/One%20Piece.PNG">
</head>
<body>
  <div class="hl-container">
    <img src="https://logos-world.net/wp-content/uploads/2021/09/One-Piece-Logo-1999.png" 
         alt="One Piece" width="400" height="200" style="max-width: 100%; height: auto;">
    
    <h1 class="menu-title">Higher or Lower - Recompensas</h1>

    <div class="hl-stats">
      <span>Racha actual: <strong id="racha-actual">0</strong></span>
      <span>Mejor racha: <strong id="mejor-racha">0</strong></span>
    </div>

    <div class="hl-cards">
      <div class="hl-card">
        <div class="hl-label">Personaje base</div>
        <img id="img-left" class="hl-img" src="" alt="Personaje base">
        <div class="hl-name" id="name-left"></div>
        <div class="hl-bounty">
          Recompensa: <span id="bounty-left"></span>
        </div>
      </div>

      <div class="hl-vs">VS</div>

      <div class="hl-card">
        <div class="hl-label">Â¿Mayor o menor recompensa?</div>
        <img id="img-right" class="hl-img" src="" alt="Siguiente personaje">
        <div class="hl-name" id="name-right"></div>
        <div class="hl-bounty">
          Recompensa: <span id="bounty-right">???</span>
        </div>
      </div>
    </div>

    <div class="hl-buttons">
      <button class="btn-opciones hl-btn" id="btn-mayor">Mayor</button>
      <button class="btn-opciones hl-btn" id="btn-menor">Menor</button>
    </div>

    <div id="hl-mensaje" class="hl-mensaje"></div>

    <button class="btn-opciones hl-btn" id="btn-reintentar" style="display:none;">
      Jugar de nuevo
    </button>

    <button class="btn-opciones hl-btn" onclick="location.href='index.html'" style="margin-top:15px;">
      ðŸ”™ Volver al menÃº
    </button>
  </div>

  <script>
    const sheetID = '1OJVVupqt0UJTB8QJKLH_UNYYaWtY41ekqpZBSlpFdxQ';
    const apiKey = 'AIzaSyAiIS758bKjVHSvAN9Ub__7dSQOWbWSLfQ';
    const sheetName = 'Imposible';
    const COL_NOMBRE = 0, COL_RECOMPENSA = 13, COL_IMAGEN = 16;

    let personajes = [], leftChar = null, rightChar = null;
    let rachaActual = 0, mejorRacha = 0;

    const imgPlaceholder = "https://logos-world.net/wp-content/uploads/2021/09/One-Piece-Logo-1999.png";

    function getRecompensaNumber(valor) {
      const digits = String(valor).replace(/[^\d-]/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }

    function formatearBerries(valor) {
      const num = getRecompensaNumber(valor);
      if (!num) return "???";
      return num.toLocaleString('es-ES') + " à¸¿";
    }

    function actualizarStats() {
      document.getElementById('racha-actual').textContent = rachaActual;
      document.getElementById('mejor-racha').textContent = mejorRacha;
    }

    function guardarMejorRacha() {
      localStorage.setItem('hl_mejor_racha', String(mejorRacha));
    }

    function cargarMejorRacha() {
      const val = localStorage.getItem('hl_mejor_racha');
      if (val) mejorRacha = parseInt(val, 10) || 0;
      actualizarStats();
    }

    function elegirPersonajeAleatorio(exceptName = null) {
      let elegido = null;
      do {
        elegido = personajes[Math.floor(Math.random() * personajes.length)];
      } while (exceptName && elegido.nombre === exceptName && personajes.length > 1);
      return elegido;
    }

    function actualizarUI() {
      document.getElementById('name-left').textContent = leftChar.nombre;
      document.getElementById('bounty-left').textContent = formatearBerries(leftChar.recompensa);
      document.getElementById('img-left').src = leftChar.imagen || imgPlaceholder;
      document.getElementById('name-right').textContent = rightChar.nombre;
      document.getElementById('bounty-right').textContent = "???";
      document.getElementById('img-right').src = rightChar.imagen || imgPlaceholder;
      document.getElementById('hl-mensaje').textContent = "";
    }

    function bloquearBotones(b) {
      document.getElementById('btn-mayor').disabled = b;
      document.getElementById('btn-menor').disabled = b;
    }

    function nuevaRonda(primeravez = false) {
      leftChar = primeravez ? elegirPersonajeAleatorio() : rightChar;
      rightChar = elegirPersonajeAleatorio(leftChar.nombre);
      actualizarUI();
      bloquearBotones(false);
      document.getElementById('btn-reintentar').style.display = 'none';
    }

    function manejarRespuesta(tipo) {
      bloquearBotones(true);
      const base = getRecompensaNumber(leftChar.recompensa);
      const comp = getRecompensaNumber(rightChar.recompensa);
      let acierto = false;
      if (tipo === "mayor" && comp > base) acierto = true;
      if (tipo === "menor" && comp < base) acierto = true;
      document.getElementById('bounty-right').textContent = formatearBerries(rightChar.recompensa);
      const mensaje = document.getElementById('hl-mensaje');
      if (acierto) {
        rachaActual++;
        if (rachaActual > mejorRacha) { mejorRacha = rachaActual; guardarMejorRacha(); }
        actualizarStats();
        mensaje.textContent = "Â¡Correcto! â˜ ï¸";
        setTimeout(() => nuevaRonda(false), 800);
      } else {
        mensaje.textContent = `Â¡Fallaste! ${rightChar.nombre} tiene ${formatearBerries(rightChar.recompensa)}.`;
        rachaActual = 0;
        actualizarStats();
        document.getElementById('btn-reintentar').style.display = 'inline-block';
      }
    }

    async function cargarPersonajes() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetID}/values/${sheetName}?key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const filas = data.values.slice(1);
      personajes = filas
        .filter(f => f[COL_RECOMPENSA] && f[COL_RECOMPENSA] !== "---")
        .map(f => ({ nombre: f[COL_NOMBRE], recompensa: f[COL_RECOMPENSA], imagen: f[COL_IMAGEN] || imgPlaceholder }));
      if (personajes.length > 230) personajes = personajes.slice(0, 230);
      cargarMejorRacha();
      nuevaRonda(true);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-mayor').onclick = () => manejarRespuesta("mayor");
      document.getElementById('btn-menor').onclick = () => manejarRespuesta("menor");
      document.getElementById('btn-reintentar').onclick = () => { rachaActual = 0; actualizarStats(); nuevaRonda(true); };
      cargarPersonajes();
    });
  </script>
</body>
</html>
